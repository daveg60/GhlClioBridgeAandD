{% extends "base.html" %}

{% block title %}Settings - GHL API Clio Integration{% endblock %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col">
        <h1><i class="bi bi-gear me-2"></i>Settings</h1>
        <p class="text-muted">Configure API connections and data mapping</p>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="settings-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="ghl-tab" data-bs-toggle="tab" data-bs-target="#ghl-settings" type="button" role="tab" aria-controls="ghl-settings" aria-selected="true">
                            <i class="bi bi-hdd-network me-2"></i>GoHighLevel
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="clio-tab" data-bs-toggle="tab" data-bs-target="#clio-settings" type="button" role="tab" aria-controls="clio-settings" aria-selected="false">
                            <i class="bi bi-hdd-network me-2"></i>Clio
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="mapping-tab" data-bs-toggle="tab" data-bs-target="#mapping-settings" type="button" role="tab" aria-controls="mapping-settings" aria-selected="false">
                            <i class="bi bi-arrows-angle-contract me-2"></i>Data Mapping
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="settings-content">
                    <!-- GoHighLevel Settings -->
                    <div class="tab-pane fade show active" id="ghl-settings" role="tabpanel" aria-labelledby="ghl-tab">
                        <form method="post" action="{{ url_for('settings') }}">
                            <input type="hidden" name="service" value="ghl">
                            
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="ghl_is_active" name="ghl_is_active" {% if ghl_config and ghl_config.is_active %}checked{% endif %}>
                                        <label class="form-check-label" for="ghl_is_active">Enable GoHighLevel Integration</label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="ghl_api_key" class="form-label">API Key</label>
                                        <input type="password" class="form-control" id="ghl_api_key" name="ghl_api_key" value="{{ ghl_config.api_key if ghl_config else '' }}">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="ghl_base_url" class="form-label">Base URL</label>
                                        <input type="text" class="form-control" id="ghl_base_url" name="ghl_base_url" value="{{ ghl_config.base_url if ghl_config else 'https://rest.gohighlevel.com/v1/' }}">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="ghl_location_id" class="form-label">Location ID (Optional)</label>
                                        <input type="text" class="form-control" id="ghl_location_id" name="ghl_location_id" value="{{ ghl_config.additional_config.location_id if ghl_config and ghl_config.additional_config and ghl_config.additional_config.location_id else '' }}">
                                        <div class="form-text">If you're using a specific location in GoHighLevel, provide its ID here.</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-dark">
                                        <div class="card-body">
                                            <h5 class="card-title">GoHighLevel Integration</h5>
                                            <p class="card-text">Set up your GoHighLevel API connection to enable data synchronization with Clio.</p>
                                            <ul class="mb-0">
                                                <li>Supports contacts, opportunities, and tasks</li>
                                                <li>Requires API key from your GoHighLevel account</li>
                                                <li>Webhook support for real-time updates</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-2"></i>Save GoHighLevel Settings
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Clio Settings -->
                    <div class="tab-pane fade" id="clio-settings" role="tabpanel" aria-labelledby="clio-tab">
                        <form method="post" action="{{ url_for('settings') }}">
                            <input type="hidden" name="service" value="clio">
                            
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="clio_is_active" name="clio_is_active" {% if clio_config and clio_config.is_active %}checked{% endif %}>
                                        <label class="form-check-label" for="clio_is_active">Enable Clio Integration</label>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="clio_api_key" class="form-label">API Key</label>
                                        <input type="password" class="form-control" id="clio_api_key" name="clio_api_key" value="{{ clio_config.api_key if clio_config else '' }}">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="clio_api_secret" class="form-label">API Secret</label>
                                        <input type="password" class="form-control" id="clio_api_secret" name="clio_api_secret" value="{{ clio_config.api_secret if clio_config else '' }}">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="clio_base_url" class="form-label">Base URL</label>
                                        <input type="text" class="form-control" id="clio_base_url" name="clio_base_url" value="{{ clio_config.base_url if clio_config else 'https://app.clio.com/api/v4/' }}">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-dark">
                                        <div class="card-body">
                                            <h5 class="card-title">Clio Integration</h5>
                                            <p class="card-text">Set up your Clio API connection to enable data synchronization with GoHighLevel.</p>
                                            <ul class="mb-0">
                                                <li>Supports contacts, matters, and tasks</li>
                                                <li>Requires API credentials from your Clio account</li>
                                                <li>Webhook support for real-time updates</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-2"></i>Save Clio Settings
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Data Mapping Settings -->
                    <div class="tab-pane fade" id="mapping-settings" role="tabpanel" aria-labelledby="mapping-tab">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">Field Mappings</h5>
                                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addMappingModal">
                                        <i class="bi bi-plus-circle me-2"></i>Add Mapping
                                    </button>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>GHL Field</th>
                                                <th>Clio Field</th>
                                                <th>Mapping Type</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="mappings-table-body">
                                            {% if mappings %}
                                                {% for mapping in mappings %}
                                                <tr data-mapping-id="{{ mapping.id }}">
                                                    <td>{{ mapping.ghl_field }}</td>
                                                    <td>{{ mapping.clio_field }}</td>
                                                    <td>{{ mapping.mapping_type }}</td>
                                                    <td>
                                                        {% if mapping.is_active %}
                                                        <span class="badge bg-success">Active</span>
                                                        {% else %}
                                                        <span class="badge bg-danger">Inactive</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <button type="button" class="btn btn-outline-primary edit-mapping-btn" data-mapping-id="{{ mapping.id }}">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-danger delete-mapping-btn" data-mapping-id="{{ mapping.id }}">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr id="no-mappings-row">
                                                    <td colspan="5" class="text-center py-4">
                                                        <i class="bi bi-exclamation-circle me-2"></i>No field mappings configured yet.
                                                    </td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-dark mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Field Mapping</h5>
                                        <p class="card-text">Define how fields should be mapped between GoHighLevel and Clio.</p>
                                        <ul class="mb-0">
                                            <li><strong>Direct:</strong> Straight field-to-field mapping</li>
                                            <li><strong>Transform:</strong> Apply transformation during mapping</li>
                                            <li><strong>Custom:</strong> Use custom logic for mapping</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="card bg-dark">
                                    <div class="card-body">
                                        <h5 class="card-title">Common Fields</h5>
                                        <p class="card-text">Suggested fields for mapping:</p>
                                        <div class="row">
                                            <div class="col-6">
                                                <p class="mb-1"><strong>GHL</strong></p>
                                                <ul class="small mb-3">
                                                    <li>firstName</li>
                                                    <li>lastName</li>
                                                    <li>email</li>
                                                    <li>phone</li>
                                                    <li>address1</li>
                                                    <li>city</li>
                                                    <li>state</li>
                                                </ul>
                                            </div>
                                            <div class="col-6">
                                                <p class="mb-1"><strong>Clio</strong></p>
                                                <ul class="small mb-3">
                                                    <li>first_name</li>
                                                    <li>last_name</li>
                                                    <li>emails.address</li>
                                                    <li>phone_numbers.number</li>
                                                    <li>addresses.street</li>
                                                    <li>addresses.city</li>
                                                    <li>addresses.province</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Mapping Modal -->
<div class="modal fade" id="addMappingModal" tabindex="-1" aria-labelledby="addMappingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMappingModalLabel">Add Field Mapping</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="mappingForm">
                    <input type="hidden" id="mapping_id" name="mapping_id">
                    
                    <div class="mb-3">
                        <label for="ghl_field" class="form-label">GoHighLevel Field</label>
                        <input type="text" class="form-control" id="ghl_field" name="ghl_field" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="clio_field" class="form-label">Clio Field</label>
                        <input type="text" class="form-control" id="clio_field" name="clio_field" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mapping_type" class="form-label">Mapping Type</label>
                        <select class="form-select" id="mapping_type" name="mapping_type">
                            <option value="direct">Direct (1:1 mapping)</option>
                            <option value="transform">Transform (apply transformation)</option>
                            <option value="custom">Custom (custom logic)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="transform_logic_container">
                        <label for="transform_logic" class="form-label">Transform Logic</label>
                        <textarea class="form-control" id="transform_logic" name="transform_logic" rows="3" placeholder="Enter transformation logic or formula"></textarea>
                        <div class="form-text">Required for transform/custom mapping types.</div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">Active</label>
                    </div>
                </form>
                
                <div class="alert alert-danger d-none" id="mapping-form-error"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMappingBtn">Save Mapping</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteMappingModal" tabindex="-1" aria-labelledby="deleteMappingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMappingModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this mapping? This action cannot be undone.</p>
                <input type="hidden" id="delete_mapping_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle mapping type change to show/hide transform logic field
    const mappingTypeSelect = document.getElementById('mapping_type');
    const transformLogicContainer = document.getElementById('transform_logic_container');
    
    function updateTransformLogicVisibility() {
        if (mappingTypeSelect.value === 'direct') {
            transformLogicContainer.classList.add('d-none');
        } else {
            transformLogicContainer.classList.remove('d-none');
        }
    }
    
    mappingTypeSelect.addEventListener('change', updateTransformLogicVisibility);
    updateTransformLogicVisibility();
    
    // Add mapping button
    const addMappingModal = new bootstrap.Modal(document.getElementById('addMappingModal'));
    const deleteMappingModal = new bootstrap.Modal(document.getElementById('deleteMappingModal'));
    
    // Save mapping button click
    document.getElementById('saveMappingBtn').addEventListener('click', function() {
        const mappingId = document.getElementById('mapping_id').value;
        const ghlField = document.getElementById('ghl_field').value;
        const clioField = document.getElementById('clio_field').value;
        const mappingType = document.getElementById('mapping_type').value;
        const transformLogic = document.getElementById('transform_logic').value;
        const isActive = document.getElementById('is_active').checked;
        
        // Validate form
        if (!ghlField || !clioField) {
            const errorElement = document.getElementById('mapping-form-error');
            errorElement.textContent = 'GHL Field and Clio Field are required.';
            errorElement.classList.remove('d-none');
            return;
        }
        
        if ((mappingType === 'transform' || mappingType === 'custom') && !transformLogic) {
            const errorElement = document.getElementById('mapping-form-error');
            errorElement.textContent = 'Transform logic is required for transform and custom mapping types.';
            errorElement.classList.remove('d-none');
            return;
        }
        
        // Prepare data for API
        const data = {
            ghl_field: ghlField,
            clio_field: clioField,
            mapping_type: mappingType,
            transform_logic: transformLogic,
            is_active: isActive
        };
        
        // Add ID if editing existing mapping
        if (mappingId) {
            data.id = parseInt(mappingId);
        }
        
        // Call API to save mapping
        fetch('/api/data-mappings', {
            method: mappingId ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Reload the page to show updated mappings
                window.location.reload();
            } else {
                const errorElement = document.getElementById('mapping-form-error');
                errorElement.textContent = result.message || 'An error occurred while saving the mapping.';
                errorElement.classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const errorElement = document.getElementById('mapping-form-error');
            errorElement.textContent = 'An unexpected error occurred.';
            errorElement.classList.remove('d-none');
        });
    });
    
    // Edit mapping button click
    document.querySelectorAll('.edit-mapping-btn').forEach(button => {
        button.addEventListener('click', function() {
            const mappingId = this.getAttribute('data-mapping-id');
            const row = document.querySelector(`tr[data-mapping-id="${mappingId}"]`);
            const cells = row.querySelectorAll('td');
            
            // Reset form
            document.getElementById('mappingForm').reset();
            document.getElementById('mapping-form-error').classList.add('d-none');
            
            // Set form values
            document.getElementById('mapping_id').value = mappingId;
            document.getElementById('ghl_field').value = cells[0].textContent;
            document.getElementById('clio_field').value = cells[1].textContent;
            document.getElementById('mapping_type').value = cells[2].textContent;
            document.getElementById('is_active').checked = cells[3].textContent.trim() === 'Active';
            
            // Update transform logic visibility
            updateTransformLogicVisibility();
            
            // Update modal title
            document.getElementById('addMappingModalLabel').textContent = 'Edit Field Mapping';
            
            // Show modal
            addMappingModal.show();
        });
    });
    
    // Delete mapping button click
    document.querySelectorAll('.delete-mapping-btn').forEach(button => {
        button.addEventListener('click', function() {
            const mappingId = this.getAttribute('data-mapping-id');
            document.getElementById('delete_mapping_id').value = mappingId;
            deleteMappingModal.show();
        });
    });
    
    // Confirm delete button click
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        const mappingId = document.getElementById('delete_mapping_id').value;
        
        // Call API to delete mapping
        fetch('/api/data-mappings', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: parseInt(mappingId) })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Reload the page to show updated mappings
                window.location.reload();
            } else {
                alert(result.message || 'An error occurred while deleting the mapping.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
        });
    });
    
    // Reset modal when hidden
    document.getElementById('addMappingModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('mappingForm').reset();
        document.getElementById('mapping_id').value = '';
        document.getElementById('mapping-form-error').classList.add('d-none');
        document.getElementById('addMappingModalLabel').textContent = 'Add Field Mapping';
    });
});
</script>
{% endblock %}
